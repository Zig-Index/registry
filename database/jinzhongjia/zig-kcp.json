{
  "name": "zig-kcp",
  "owner": "jinzhongjia",
  "repo": "zig-kcp",
  "description": "KCP - A Fast and Reliable ARQ Protocol (Zig Implementation)",
  "type": "package",
  "topics": [
    "kcp",
    "zig",
    "zig-package",
    "ziglang",
    "zig-kcp"
  ],
  "stars": 1,
  "forks": 0,
  "watchers": 1,
  "updated_at": "2025-10-30T23:52:04Z",
  "minimum_zig_version": "0.15.0",
  "readme": "# KCP - A Fast and Reliable ARQ Protocol (Zig Implementation)\n\nEnglish | [简体中文](README.zh-CN.md)\n\nA Zig implementation of the KCP protocol, based on the original C implementation by skywind3000.\n\n## Introduction\n\nKCP is a fast and reliable ARQ (Automatic Repeat reQuest) protocol that offers significant advantages over TCP:\n\n- 30-40% average RTT reduction compared to TCP\n- 3x reduction in maximum RTT\n- Lightweight, modular implementation\n\n## Features\n\n- ✅ Complete ARQ protocol implementation\n- ✅ Fast retransmission mechanism\n- ✅ Congestion control\n- ✅ Window management\n- ✅ RTT calculation\n- ✅ Memory safety (Zig feature)\n- ✅ No unsafe code\n- ✅ 59 unit tests (100% API coverage)\n- ✅ Performance benchmarks\n\n## Quick Start\n\n### Installation\n\n```bash\n# Clone the repository\ngit clone https://github.com/yourusername/zig-kcp.git\ncd zig-kcp\n\n# Run tests\nzig build test\n\n# Run benchmarks\nzig build bench\n```\n\n### Basic Usage\n\n```zig\nconst std = @import(\"std\");\nconst kcp = @import(\"kcp\");\n\n// 1. Define output callback function (for sending underlying packets)\nfn outputCallback(buf: []const u8, k: *kcp.Kcp, user: ?*anyopaque) !i32 {\n    // Send data via UDP socket\n    // This is just an example\n    return @as(i32, @intCast(buf.len));\n}\n\npub fn main() !void {\n    const allocator = std.heap.page_allocator;\n\n    // 2. Create KCP instance\n    const conv: u32 = 0x12345678; // Conversation ID, must be same for both peers\n    const kcp_inst = try kcp.create(allocator, conv, null);\n    defer kcp.release(kcp_inst);\n\n    // 3. Set output callback\n    kcp.setOutput(kcp_inst, &outputCallback);\n\n    // 4. Configure KCP (optional)\n    // Parameters: nodelay, interval, resend, nc\n    // Normal mode: setNodelay(0, 40, 0, 0)\n    // Fast mode: setNodelay(1, 10, 2, 1)\n    kcp.setNodelay(kcp_inst, 1, 10, 2, 1);\n\n    // 5. Send data\n    const message = \"Hello, KCP!\";\n    _ = try kcp.send(kcp_inst, message);\n\n    // 6. Update periodically (e.g., every 10ms)\n    const current = @as(u32, @intCast(std.time.milliTimestamp()));\n    try kcp.update(kcp_inst, current);\n\n    // 7. Call input when receiving underlying packets\n    // const data = ...; // Data received from UDP socket\n    // _ = try kcp.input(kcp_inst, data);\n\n    // 8. Read received data\n    var buffer: [1024]u8 = undefined;\n    const len = try kcp.recv(kcp_inst, &buffer);\n    if (len > 0) {\n        std.debug.print(\"Received: {s}\\n\", .{buffer[0..@as(usize, @intCast(len))]});\n    }\n}\n```\n\n## API Documentation\n\n### Creation and Destruction\n\n#### `create(allocator, conv, user)`\n\nCreate a KCP instance\n\n- `allocator`: Memory allocator\n- `conv`: Conversation ID, must be the same for both communicating peers\n- `user`: User-defined data pointer (optional)\n\n#### `release(kcp)`\n\nRelease the KCP instance and its resources\n\n### Configuration Functions\n\n#### `setOutput(kcp, callback)`\n\nSet the output callback function, which KCP uses to send underlying packets\n\n```zig\nfn callback(buf: []const u8, kcp: *Kcp, user: ?*anyopaque) !i32\n```\n\n#### `setNodelay(kcp, nodelay, interval, resend, nc)`\n\nConfigure KCP working mode\n\n- `nodelay`: 0=disabled (default), 1=enabled\n- `interval`: Internal update interval (milliseconds), default 100ms\n- `resend`: Fast retransmission trigger count, 0=disabled (default)\n- `nc`: 0=normal congestion control (default), 1=disable congestion control\n\n**Recommended configurations:**\n\n- Normal mode: `setNodelay(0, 40, 0, 0)`\n- Fast mode: `setNodelay(1, 20, 2, 1)`\n- Turbo mode: `setNodelay(1, 10, 2, 1)`\n\n#### `setMtu(kcp, mtu)`\n\nSet MTU size, default 1400 bytes\n\n#### `wndsize(kcp, sndwnd, rcvwnd)`\n\nSet send and receive window sizes\n\n- `sndwnd`: Send window, default 32\n- `rcvwnd`: Receive window, default 128\n\n### Data Transfer\n\n#### `send(kcp, buffer)`\n\nSend data\n\n- Return value: Returns the number of bytes sent on success, negative on error\n\n#### `recv(kcp, buffer)`\n\nReceive data\n\n- Return value: Returns the number of bytes received on success, negative on error\n  - `-1`: Receive queue is empty\n  - `-2`: Incomplete packet\n  - `-3`: Buffer too small\n\n#### `input(kcp, data)`\n\nInput underlying packet data into KCP (e.g., data received from UDP)\n\n### Update and Check\n\n#### `update(kcp, current)`\n\nUpdate KCP state, should be called periodically (recommended: 10-100ms)\n\n- `current`: Current timestamp (milliseconds)\n\n#### `check(kcp, current)`\n\nCheck when to call update next\n\n- Return value: Timestamp for the next update (milliseconds)\n\n### Other Functions\n\n#### `flush(kcp)`\n\nImmediately flush pending data\n\n#### `peeksize(kcp)`\n\nGet the size of the next message in the receive queue\n\n#### `waitsnd(kcp)`\n\nGet the number of packets waiting to be sent\n\n#### `getconv(data)`\n\nExtract conversation ID from a packet\n\n## Build and Test\n\n```bash\n# Run unit tests\nzig build test\n\n# Run performance benchmarks (fast, suitable for CI)\nzig build bench\n\n# Run integration tests with network simulation (slow, for manual testing)\nzig build perf\n\n# View detailed test output\nzig build test --summary all\n```\n\n## How It Works\n\nKCP is an ARQ (Automatic Repeat reQuest) protocol operating at the application layer, designed to work with unreliable transport protocols like UDP.\n\n### Basic Flow\n\n1. **Sender:**\n   - Call `send()` to queue data\n   - Call `update()` to trigger KCP processing\n   - KCP sends packets via the output callback\n\n2. **Receiver:**\n   - Call `input()` when receiving packets from UDP\n   - Call `recv()` to read reassembled data\n\n3. **Timer:**\n   - Periodically call `update()` to handle retransmissions, ACKs, etc.\n\n### Protocol Header (24 bytes)\n\n```\n0               4       5       6       8       12      16      20      24\n+---------------+-------+-------+-------+-------+-------+-------+-------+\n|     conv      |  cmd  |  frg  |  wnd  |   ts  |   sn  |  una  |  len  |\n+---------------+-------+-------+-------+-------+-------+-------+-------+\n```\n\n- `conv`: Conversation ID (4 bytes)\n- `cmd`: Command type (1 byte): PUSH, ACK, WASK, WINS\n- `frg`: Fragment number (1 byte)\n- `wnd`: Window size (2 bytes)\n- `ts`: Timestamp (4 bytes)\n- `sn`: Sequence number (4 bytes)\n- `una`: Unacknowledged sequence number (4 bytes)\n- `len`: Data length (4 bytes)\n\n## Performance Tuning\n\n1. **Reduce latency:**\n   - Use `setNodelay(1, 10, 2, 1)` configuration\n   - Decrease `interval` parameter\n   - Enable fast retransmission\n\n2. **Increase throughput:**\n   - Increase send/receive window sizes\n   - Increase MTU (if network supports)\n   - Disable congestion control (in controlled network environments)\n\n3. **Reduce CPU usage:**\n   - Increase `interval` parameter appropriately\n   - Use `check()` to optimize `update()` call frequency\n\n## Test Coverage\n\n- ✅ 59 unit tests\n- ✅ 100% API coverage\n- ✅ Fuzz testing (random input, malformed packets)\n- ✅ Stress testing (large data, multiple packets)\n- ✅ Boundary testing (edge values, wraparound)\n- ✅ Performance benchmarks\n\n### Test Categories\n\n| Category           | Count | Coverage                                      |\n| ------------------ | ----- | --------------------------------------------- |\n| Basic Functions    | 9     | Encode/decode, utilities, create/release      |\n| Configuration      | 6     | MTU, window, nodelay, stream mode             |\n| Error Handling     | 5     | Invalid conv, corrupted data, buffer issues   |\n| ARQ Mechanisms     | 5     | Timeout retransmission, fast retransmission   |\n| Fragmentation      | 2     | Large data, multi-fragment reassembly         |\n| Advanced Features  | 3     | Window probe, flush, window full              |\n| Fuzz Testing       | 3     | Random input, malformed packets, edge values  |\n| Stress Testing     | 3     | Many small packets, large data, bidirectional |\n| Boundary Testing   | 8     | MTU, window, sequence wraparound              |\n| Dead Link          | 2     | Complete loss, gradual retransmission         |\n| Receive Window     | 3     | Window full, flow control, zero window        |\n| RTT Testing        | 2     | RTT calculation, delay variation              |\n| Congestion Control | 2     | ssthresh adjustment, slow start               |\n| Timestamp          | 2     | Wraparound, time jump                         |\n| Interval           | 3     | Update frequency, flush timing                |\n| Nodelay Modes      | 3     | Normal, fast, comparison                      |\n\n## Differences from Original C Implementation\n\n1. **Memory Management:**\n   - Uses Zig's Allocator for memory management\n   - All resources managed automatically via defer\n\n2. **Data Structures:**\n   - Uses `ArrayList` instead of C linked lists\n   - Cleaner memory layout\n\n3. **Type Safety:**\n   - Strong type system prevents type conversion errors\n   - Compile-time overflow checking\n\n4. **Error Handling:**\n   - Uses Zig's error union types\n   - Explicit error propagation\n\n5. **Modularity:**\n   - Code split into multiple modules (types, utils, codec, control, protocol)\n   - Clearer code organization\n\n## License\n\nThis implementation is based on the original KCP protocol by skywind3000.\n\n## References\n\n- [Original KCP Repository](https://github.com/skywind3000/kcp)\n",
  "owner_avatar_url": "https://avatars.githubusercontent.com/u/41784264?u=d300cf8becbfebb495634687c971048a63c07d2a&v=4",
  "releases": [],
  "owner_bio": "Programming is like building blocks",
  "owner_company": null,
  "owner_location": "Singapore",
  "owner_blog": "https://blog.nvimer.org",
  "owner_twitter_username": null,
  "owner_followers": 82,
  "owner_following": 18,
  "owner_created_at": "2018-07-27T10:00:34Z",
  "category": "library"
}